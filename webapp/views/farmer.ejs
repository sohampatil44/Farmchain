<!DOCTYPE html>
<html lang="en" id="html">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-en="Farmer Portal" data-mr="à¤¶à¥‡à¤¤à¤•à¤°à¥€ à¤ªà¥‹à¤°à¥à¤Ÿà¤²">Farmer Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Serif+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/speech.css">

  <style>
    body { font-family: 'Inter', sans-serif; }
    [lang="mr"] { font-family: 'Noto Serif Devanagari', sans-serif; }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 50;
    }

    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 24px;
      width: 90%;
      max-width: 600px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen text-slate-800">

<div id="speech-controls" class="speech-controls">
  <div class="text-sm font-semibold mb-2">Text-to-Speech</div>
  <button id="stop-speech" class="speech-btn">Stop</button>
  <button id="pause-speech" class="speech-btn">Pause</button>
  <button id="resume-speech" class="speech-btn">Resume</button>
</div>

<%- include('partials/header') %>

<div class="max-w-7xl mx-auto px-6 py-8">

  <!-- Language Switch -->
  <div class="flex justify-end gap-2 mb-6">
    <button class="lang-btn active" onclick="window.FarmChainSpeech.setLanguage('en')">English</button>
    <button class="lang-btn" onclick="window.FarmChainSpeech.setLanguage('mr')">à¤®à¤°à¤¾à¤ à¥€</button>
  </div>

  <!-- Welcome -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold mb-2 speakable">
      Welcome, <%= farmerName %> ðŸ‘‹
    </h1>
    <p class="text-slate-500">Manage equipment rentals and track your usage</p>
  </div>

  <!-- Analytics CTA -->
  <div class="flex justify-center mb-10">
    <a href="/farmer/analytics"
       class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl shadow-md transition font-medium">
      ðŸ“Š View Usage Analytics
    </a>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-2xl shadow p-6 mb-10">
    <form class="flex flex-wrap gap-4 items-center" method="GET">
      <select name="region" class="border rounded-lg px-3 py-2">
        <option value="">Select Region</option>
        <% REGIONS.forEach(function(r) { %>
          <option value="<%= r %>" <%= region === r ? 'selected' : '' %>><%= r %></option>
        <% }); %>
      </select>

      <select name="category" class="border rounded-lg px-3 py-2">
        <option value="all">All Categories</option>
        <% CATEGORIES.forEach(function(c) { %>
          <option value="<%= c %>" <%= category === c ? 'selected' : '' %>>
            <%= CATEGORY_TRANSLATIONS[c] || c %>
          </option>
        <% }); %>
      </select>

      <input type="text"
             name="q"
             placeholder="Search equipment..."
             value="<%= query %>"
             class="border rounded-lg px-4 py-2 flex-1"/>

      <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg transition">
        Filter
      </button>
    </form>
  </div>

  <!-- Listings -->
  <h2 class="text-2xl font-bold text-center mb-8 text-emerald-700 speakable">
    Available Equipment
  </h2>

  <% if(listings && listings.length > 0) { %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      <% listings.forEach(function(l) { 
        const imgUrl = (l.img && l.img.trim() !== "") ? l.img : "https://via.placeholder.com/400x200";
      %>
        <div class="bg-white rounded-2xl shadow hover:shadow-xl transition overflow-hidden flex flex-col">
          <div class="h-44 bg-cover bg-center" style="background-image:url('<%= imgUrl %>')"></div>

          <div class="p-5 flex flex-col flex-1">
            <h3 class="font-semibold text-lg mb-1 speakable">
              <%= CATEGORY_TRANSLATIONS[l.name] || l.name %>
            </h3>

            <p class="text-sm text-slate-500 mb-1">
              <%= CATEGORY_TRANSLATIONS[l.category] || l.category %> â€¢ <%= l.region %>
            </p>

            <p class="text-emerald-700 font-semibold mb-1">
              â‚¹<%= l.pricePerDay %> / day
            </p>

            <p class="text-sm text-slate-500 mb-4">
              Condition: <%= l.condition %>
            </p>

            <form method="POST" action="/farmer/initiate-booking/<%= l._id %>" class="mt-auto flex gap-2">
              <input type="number"
                     name="days"
                     min="1"
                     required
                     placeholder="Days"
                     class="border rounded-lg px-3 py-2 w-24"/>

              <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition">
                Book
              </button>
            </form>
          </div>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <p class="text-center text-slate-500 py-10">No equipment found</p>
  <% } %>

  <!-- Orders -->
  <div class="mt-16">
    <h2 class="text-2xl font-bold mb-6 speakable">Your Orders</h2>

    <% if (bookings && bookings.length > 0) { %>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
        <% bookings.forEach(function(booking) { if (booking.status === 'confirmed') { %>
          <div class="bg-white rounded-2xl shadow p-5 hover:shadow-xl transition">
            <h3 class="font-semibold mb-1">Order for <%= booking.listing.name %></h3>
            <p class="text-sm text-slate-500">Seller: <%= booking.listing.sellerName %></p>
            <p class="font-medium text-emerald-700 mt-2">â‚¹<%= booking.amount %></p>
            <p class="text-sm text-slate-500 mb-4">
              Days: <%= Math.round((booking.to - booking.from) / 86400000) %>
            </p>

            <button onclick="showOrderDetails('<%= JSON.stringify(booking) %>')"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
              View Details
            </button>
          </div>
        <% }}); %>
      </div>
    <% } else { %>
      <p class="text-center text-slate-500 py-10">No orders yet</p>
    <% } %>
  </div>

  <!-- Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <button class="float-right text-xl font-bold"
              onclick="document.getElementById('orderModal').style.display='none'">Ã—</button>
      <h2 class="text-xl font-bold mb-4">Order Details</h2>
      <p id="orderDetails" class="text-slate-700"></p>
    </div>
  </div>

</div>

<%- include('partials/footer') %>

<script src="/js/speech.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    window.FarmChainSpeech.setLanguage('en');
  });

  function showOrderDetails(bookingJson) {
    const booking = JSON.parse(bookingJson);
    document.getElementById('orderDetails').innerHTML = `
      Booking ID: ${booking._id}<br>
      Equipment: ${booking.listing.name}<br>
      Seller: ${booking.listing.sellerName}<br>
      Days: ${(new Date(booking.to) - new Date(booking.from)) / 86400000}<br>
      Amount: â‚¹${booking.amount}<br>
      Tx Hash: ${booking.txHash}<br>
      Date: ${new Date(booking.createdAt).toLocaleString()}
    `;
    document.getElementById('orderModal').style.display = "block";
  }
</script>

</body>
</html>
